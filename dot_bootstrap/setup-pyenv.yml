---
- name: Pyenv setup
  hosts: ubuntuNode1
  gather_facts: false
  become: true
  tasks:
    - name: set fact for user
      ansible.builtin.set_fact:
        default_user: /home/ubuntu
        # default_user: /home/sandheepkumar

    - name: Install build tools
      ansible.builtin.apt:
        name:
          - build-essential
          - libssl-dev
          - zlib1g-dev
          - libbz2-dev
          - libreadline-dev
          - libsqlite3-dev
          - curl
          - libncursesw5-dev
          - xz-utils
          - tk-dev
          - libxml2-dev
          - libxmlsec1-dev
          - libffi-dev
          - liblzma-dev
      become: true


    - name: Clone pyenv
      ansible.builtin.git:
        repo: https://github.com/pyenv/pyenv.git
        dest: "{{ default_user }}/.pyenv/"
        clone: yes
        update: yes
    
    # - name: Install pyenv
    #   ansible.builtin.shell:
    #     cmd: |
    #       curl https://pyenv.run | bash

    - name: Get latest python
      ansible.builtin.shell:
        cmd: |
          {{ default_user }}/.pyenv/bin/pyenv install --list | grep --extended-regexp "^\s*[0-9][0-9.]*[0-9]\s*$" | tail -1
      register: latest_python_version

    - name: Install latest python using pyenv
      ansible.builtin.shell:
        cmd: |
          {{ default_user }}/.pyenv/bin/pyenv install {{ latest_python_version.stdout | trim }}

    - name: Set default python
      ansible.builtin.shell:
        cmd: |
          {{ default_user }}/.pyenv/bin/pyenv global {{ latest_python_version.stdout | trim }}

    - name: Update .bashrc
      ansible.builtin.lineinfile:
        path: "{{ default_user }}/.bashrc"
        line: "{{ item }}"
        create: yes
      loop:
        - 'echo "export PYENV_ROOT="$HOME/.pyenv"" >> ~/.bashrc'
        - 'echo "command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"" >> ~/.bashrc'
        - 'echo "eval "$(pyenv init -)"" >> ~/.bashrc'

